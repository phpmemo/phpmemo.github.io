---
layout: note
title: "Front Controller — паттерн с единой точкой входа (index.php)"
card_id: 16
date: 2025-09-16
card_type: technique # theory, technique, practice
categories: ["PHP Basics"]
difficulty: 2 # Уровень сложности (опционально)
icon: book # book, lightning-bolt, check-circle (соответствует типу)
question: |
  Во многих веб-приложениях имеется файл index.php внутри которого производится некоторая первоначальная настройка и в конце подключается файл, занимающимся дальнейшим запуском приложения. Как бы вы формализовали данную технику в веб-программировании?

short_answer: |
  **Front Controller** — паттерн с единой точкой входа (`index.php`). Он принимает запросы, выполняет первичную настройку и делегирует обработку `bootstrap.php`, который инициализирует ядро приложения (автозагрузку, контейнер, конфиги). Разделение обеспечивает гибкость, повторное использование кода и соблюдение SRP.
---
Данная техника формализуется как **«Фронт-контроллер» (Front Controller)**.

Это архитектурный паттерн проектирования, характерный именно для веб-приложений.

---

### Суть паттерна «Фронт-контроллер»

**Все входящие HTTP-запросы перенаправляются через единую точку входа (единый скрипт) — файл `index.php`.** Этот скрипт отвечает за первичную обработку *всех* запросов, а затем делегирует выполнение конкретной логике приложения.

### Как это формализуется в коде:

1.  **Единая точка входа (Entry Point):** Веб-сервер (например, Apache через `.htaccess` или Nginx через `try_files`) настраивается так, чтобы все запросы (кроме статических файлов) перенаправлялись на `index.php`.
    *   **Пример `.htaccess` (Apache):**
        ```apache
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]
        ```

2.  **Первоначальная настройка (Bootstrap):** Файл `index.php` выполняет всю общую, обязательную логику:
    *   **Настройка окружения:** Определение констант, настройка `include_path`.
    *   **Безопасность:** Фильтрация входящих данных, инициализация сессии.
    *   **Автозагрузка:** Подключение Composer Autoload (`require 'vendor/autoload.php'`).
    *   **Инициализация:** Создание и конфигурация ключевых объектов (контейнер зависимостей, логгер, подключение к БД).
    *   **Маршрутизация (Routing):** Анализ URL-запроса (`$_SERVER['REQUEST_URI']`) и определение того, какой контроллер и действие должны его обработать.

3.  **Запуск ядра приложения (Delegation):** После всей настройки `index.php` не содержит бизнес-логики. Его задача — передать управление ядру приложения, которое уже знает, что делать дальше.
    ```php
    // index.php после всей настройки

    // Создаем экземпляр ядра нашего приложения, передавая ему сконфигурированные зависимости
    $app = new AppKernel($container, $router, $logger);

    // Запускаем приложение, передавая ему входящий запрос
    $response = $app->handle(Request::createFromGlobals());

    // Отправляем сформированный ответ клиенту
    $response->send();
    ```

### Преимущества этого подхода:

1.  **Централизованное управление:** Вся общая логика (безопасность, аутентификация, логирование) находится в одном месте, а не дублируется в десятках скриптов.
2.  **Гибкость:** Легко добавить новую функциональность на уровне всего приложения (например, кеширование, проверку прав доступа), просто добавив код в `index.php` или ядро приложения.
3.  **Чистота URL:** Позволяет использовать «человекочитаемые» и SEO-дружественные адреса (например, `/catalog/product/123` вместо `/product.php?id=123`).
4.  **Безопасность:** Контроль над всем входящим трафиком из одного скрипта упрощает внедрение мер безопасности.

### Формальное название техники в конце файла:

Процесс передачи управления от фронт-контроллера (`index.php`) к следующему слою приложения формально называется **«Делегирование обработки запроса» (Request Delegation)** или **«Запуск ядра приложения»**.

**Таким образом, техника формально описывается как реализация паттерна «Фронт-контроллер», где `index.php` выступает в роли единой точки входа, занимается первичной настройкой (бутстрапингом) и делегирует дальнейшую обработку запроса ядру приложения.**

## Монолитный и Раздельный Front Controller 

Как паттерн применяется на практике:

1.  **`/public/index.php` — это чистый "Фронт-контроллер" (Front Controller).**
    *   Его единственная задача — быть **единой точкой входа (entry point)** для всех веб-запросов.
    *   Он выполняет минимально необходимую **первичную настройку** (bootstrap), специфичную именно для веб-окружения:
        *   Определение корневой директории приложения (`define('ROOT', dirname(__DIR))`).
        *   Настройка базовых констант среды выполнения (`APP_ENV`, `DEBUG`).
        *   Указание путей для автозагрузчика.
    *   Его ключевое действие — **делегирование**. Он не знает о внутреннем устройстве приложения. Он просто загружает и передает управление следующему, более важному компоненту — `bootstrap.php`.
    *   **Аналогия из реального мира:** это **швейцар** на входе в здание. Его работа — принять всех гостей (запросы), убедиться, что они пришли в нужное место (направить все запросы на себя через `.htaccess`), и передать их **дежурному администратору** (`bootstrap.php`). Сам швейцар не решает, что происходит внутри здания.

2.  **`/core/bootstrap.php` — это "Загрузчик приложения" или "Ядро инициализации" (Application Kernel / Bootstrapper).**
    *   Он получает управление от фронт-контроллера и занимается **настройкой самого приложения**:
        *   **Регистрация автозагрузчика** (например, через Composer `require ROOT . '/vendor/autoload.php'`).
        *   **Настройка обработки ошибок и исключений** (например, установка своего обработчика для логирования в файл).
        *   **Конфигурация зависимостей** (создание и настройка Контейнера внедрения зависимостей - DIC).
        *   **Загрузка конфигураций** (база данных, кеш, почта).
    *   Его финальная задача — **создать и запустить само приложение**.
    *   **Аналогия:** это **дежурный администратор**. Он получает гостя от швейцара и делает всю подготовительную работу: включает свет (автозагрузку), настраивает лифты (контейнер зависимостей), проверяет расписание (конфиги) и зовёт **менеджера** (роутер или ядро приложения), который уже знает, куда именно проводить гостя.

### Как это выглядит в коде:

**`/public/index.php` (Фронт-контроллер):**
```php
<?php
// 1. Первичная настройка ВЕБ-окружения
declare(strict_types=1);
define('ROOT', dirname(__DIR__));
define('PUBLIC', __DIR__);

// 2. Делегирование: подключение загрузчика приложения
require ROOT . '/core/bootstrap.php';
```
*Здесь нет автозагрузки, нет контейнера — только голые основы.*

**`/core/bootstrap.php` (Загрузчик приложения):**
```php
<?php
// 1. Настройка самого приложения
require ROOT . '/vendor/autoload.php'; // Автозагрузка классов

// 2. Конфигурация
$container = new Container();
$container->set('config', require ROOT . '/config/app.php');

// 3. Регистрация обработчиков
set_error_handler([ErrorHandler::class, 'handle']);
set_exception_handler([ExceptionHandler::class, 'handle']);

// 4. СОЗДАНИЕ и ЗАПУСК приложения
$app = new App($container);
$app->run();
```
### Ключевые различия:

| Критерий | `index.php` (Фронт-контроллер) | `bootstrap.php` (Загрузчик) |
| :--- | :--- | :--- |
| **Знание о HTTP** | **Да.** Его существование оправдано только веб-запросами. | **Нет.** Он абстрагирован от протокола. Его можно вызвать из CLI-скрипта. |
| **Уровень абстракции** | **Низкий.** Работает с суперглобальными массивами (`$_SERVER`, `$_GET`). | **Высокий.** Работает с концепциями приложения: сервисы, конфиги, обработчики. |
| **Ответственность** | Принять запрос и делегировать его. | **Сконфигурировать** среду для обработки **любого** запроса. |
| **Повторное использование** | Нет. Привязан к вебу. | **Да.** Его можно использовать для инициализации и веб-приложения, и фонового работника, и CLI-команды. |

### Сравнительная характеристика

| Аспект | Монолитный `index.php` | Раздельный `index.php` + `bootstrap.php` |
| :--- | :--- | :--- |
| **Соответствие паттерну** | **Да, это классический Фронт-контроллер.** | **Да, это более продвинутая реализация того же паттерна.** |
| **Чистота паттерна** | Более чистая, но "тяжелая" реализация. | Паттерн усложняется за счет разделения ответственности. |
| **Гибкость** | Низкая. Привязан только к вебу. | **Высокая.** `bootstrap.php` можно переиспользовать для CLI, тестов и т.д. |
| **Тестируемость** | Сложнее тестировать, так как всё завязано на веб-окружении. | **Проще.** Можно тестировать логику инициализации отдельно. |
| **Читаемость** | Может стать очень большим и сложным для восприятия. | Лучше. Код разделен по смысловым блокам. |


### Как выглядит полная цепочка после разделения:

`Веб-запрос -> Веб-сервер -> .htaccess -> **/public/index.php** (Фронт-контроллер) -> require **/core/bootstrap.php** (Загрузчик) -> Создание Контейнера, Автозагрузка -> Запуск **/src/Kernel.php** (Ядро Приложения) -> Маршрутизация -> Контроллер -> Ответ`

### Итог:

Такое разделение считается **лучшей практикой** по нескольким причинам:

*   **Разделение ответственности:** `index.php` отвечает только за веб, а `bootstrap.php` — за логику приложения. Это позволяет, например, создать еще один фронт-контроллер для CLI (`/bin/console`) с другой первичной настройкой, но который будет использовать тот же самый `bootstrap.php` для инициализации ядра приложения.
*   **Тестируемость:** Ядро приложения (`bootstrap.php`) можно протестировать отдельно, без эмуляции веб-запросов.
*   **Чистота кода:** Фронт-контроллер остается максимально простым и понятным.
